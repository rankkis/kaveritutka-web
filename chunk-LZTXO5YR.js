import{a as w,b as O}from"./chunk-IKLCL2V4.js";import{a as A}from"./chunk-6DBU55DM.js";import"./chunk-X5YLR3NI.js";import{h as M,p as _,r as P}from"./chunk-642DS5T4.js";import{$a as g,Cb as v,Fb as a,Gb as c,Hb as C,Mb as S,Wb as p,Xb as x,eb as i,lb as k,qb as b}from"./chunk-3324XCKI.js";import{i as f}from"./chunk-ODN5LVDJ.js";function j(t,n){if(t&1&&(a(0,"p",2),p(1),c()),t&2){let e=S();g(),x(e.errorMessage)}}function E(t,n){t&1&&(a(0,"p",3),p(1,"Kirjaudutaan sis\xE4\xE4n..."),c())}var I=class t{constructor(n,e,o){this.route=n;this.router=e;this.supabaseService=o}errorMessage="";ngOnInit(){return f(this,null,function*(){console.log("AuthCallback: Processing OAuth callback from backend");let e=(yield this.route.queryParams.toPromise())?.error;if(e){this.errorMessage="Kirjautuminen ep\xE4onnistui. Yrit\xE4 uudelleen.",console.error("OAuth error:",e),setTimeout(()=>this.router.navigate(["/"]),3e3);return}let o=window.location.hash.substring(1);if(console.log("URL hash:",o),!o){console.error("No hash fragment found in URL"),this.errorMessage="Kirjautuminen ep\xE4onnistui. Yrit\xE4 uudelleen.",setTimeout(()=>this.router.navigate(["/"]),2e3);return}let s=new URLSearchParams(o),l=s.get("access_token"),u=s.get("refresh_token"),T=s.get("user_id"),y=s.get("user_name");if(console.log("Parsed tokens:",{hasAccessToken:!!l,hasRefreshToken:!!u,userId:T,userName:y}),!l||!u){console.error("Missing tokens in hash fragment"),this.errorMessage="Kirjautuminen ep\xE4onnistui. Yrit\xE4 uudelleen.",setTimeout(()=>this.router.navigate(["/"]),2e3);return}console.log("Setting session with tokens...");let{data:r,error:m}=yield this.supabaseService.getClient().auth.setSession({access_token:l,refresh_token:u});if(console.log("setSession result:",{data:r,error:m}),m||!r.session){console.error("Error setting session:",m),this.errorMessage="Kirjautuminen ep\xE4onnistui. Yrit\xE4 uudelleen.",setTimeout(()=>this.router.navigate(["/"]),2e3);return}console.log("Session set successfully:",{user:r.session.user.email,expiresAt:r.session.expires_at}),yield new Promise(R=>setTimeout(R,100));let h=this.supabaseService.getSession();console.log("Current session after setSession:",{hasSession:!!h,userEmail:h?.user?.email}),window.history.replaceState({},document.title,window.location.pathname);let d=this.checkIfNewUser();console.log("Navigating to:",d?"/welcome":"/"),d?this.router.navigate(["/welcome"]):this.router.navigate(["/"])})}checkIfNewUser(){return localStorage.getItem("hasSeenWelcome")?!1:(localStorage.setItem("hasSeenWelcome","true"),!0)}static \u0275fac=function(e){return new(e||t)(i(_),i(P),i(A))};static \u0275cmp=k({type:t,selectors:[["app-auth-callback"]],decls:4,vars:1,consts:[[1,"callback-container"],["diameter","60"],[1,"error-message"],[1,"loading-message"]],template:function(e,o){e&1&&(a(0,"div",0),C(1,"mat-spinner",1),b(2,j,2,1,"p",2)(3,E,2,0,"p",3),c()),e&2&&(g(2),v(o.errorMessage?2:3))},dependencies:[M,O,w],styles:[".callback-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100vh - 64px);padding:40px 20px;background-color:#f5f5f5;text-align:center}.callback-container[_ngcontent-%COMP%]   mat-spinner[_ngcontent-%COMP%]{margin-bottom:24px}.callback-container[_ngcontent-%COMP%]   .loading-message[_ngcontent-%COMP%]{font-size:18px;color:#000000b3;margin:0}.callback-container[_ngcontent-%COMP%]   .error-message[_ngcontent-%COMP%]{font-size:16px;color:#f44336;margin:0}@media (max-width: 768px){.callback-container[_ngcontent-%COMP%]{min-height:calc(100vh - 56px);padding:32px 16px}.callback-container[_ngcontent-%COMP%]   .loading-message[_ngcontent-%COMP%], .callback-container[_ngcontent-%COMP%]   .error-message[_ngcontent-%COMP%]{font-size:16px}}"]})};export{I as AuthCallbackComponent};
