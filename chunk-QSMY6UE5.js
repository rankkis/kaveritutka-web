import{a as O,b as P}from"./chunk-OTJWB52N.js";import{a as _}from"./chunk-NNFLGY3X.js";import"./chunk-X5YLR3NI.js";import{h as x,p as k,r as M}from"./chunk-SX76S77R.js";import{C as g,Db as h,Gb as a,Hb as s,I as d,Ib as v,Nb as C,Xb as l,Yb as S,ab as c,fb as r,mb as f,r as p,rb as b}from"./chunk-ZZFAEQCX.js";import{i as m}from"./chunk-ODN5LVDJ.js";function y(n,t){if(n&1&&(a(0,"p",2),l(1),s()),n&2){let e=C();c(),S(e.errorMessage)}}function I(n,t){n&1&&(a(0,"p",3),l(1,"Kirjaudutaan sis\xE4\xE4n..."),s())}var w=class n{constructor(t,e,o){this.route=t;this.router=e;this.supabaseService=o}errorMessage="";sessionSubscription;ngOnInit(){return m(this,null,function*(){console.log("AuthCallback: Processing OAuth callback"),console.log("Current URL:",window.location.href);let t=yield p(this.route.queryParams),e=t?.error;if(console.log("Query params:",t),console.log("Error param:",e),e){this.errorMessage="Kirjautuminen ep\xE4onnistui. Yrit\xE4 uudelleen.",console.error("OAuth error:",e),setTimeout(()=>this.router.navigate(["/map"]),3e3);return}console.log("Waiting for Supabase to process callback..."),yield new Promise(i=>setTimeout(i,1e3));let o=this.supabaseService.getSession();if(console.log("Checking for existing session:",o?"found":"not found"),o){console.log("Session already available:",o.user.email),this.completeLogin();return}console.log("Waiting for session via observable...");let u=setTimeout(()=>{console.error("Timeout waiting for session after OAuth callback"),this.errorMessage="Kirjautuminen ep\xE4onnistui. Yrit\xE4 uudelleen.",setTimeout(()=>this.router.navigate(["/map"]),2e3)},1e4);this.sessionSubscription=this.supabaseService.session$.pipe(g(i=>i!==null),d(1)).subscribe({next:i=>{clearTimeout(u),console.log("Session received via observable:",i.user.email),this.completeLogin()},error:i=>{console.error("Error in session subscription:",i),clearTimeout(u),this.errorMessage="Kirjautuminen ep\xE4onnistui. Yrit\xE4 uudelleen.",setTimeout(()=>this.router.navigate(["/map"]),2e3)}})})}completeLogin(){console.log("completeLogin() called"),window.history.replaceState({},document.title,window.location.pathname);let t=this.checkIfNewUser(),e=t?"/welcome":"/map";console.log("Is new user:",t),console.log("Target route:",e),console.log("About to navigate..."),this.router.navigate([e],{replaceUrl:!0}).then(o=>console.log("Navigation success:",o),o=>console.error("Navigation error:",o))}ngOnDestroy(){this.sessionSubscription&&this.sessionSubscription.unsubscribe()}checkIfNewUser(){return localStorage.getItem("hasSeenWelcome")?!1:(localStorage.setItem("hasSeenWelcome","true"),!0)}static \u0275fac=function(e){return new(e||n)(r(k),r(M),r(_))};static \u0275cmp=f({type:n,selectors:[["app-auth-callback"]],decls:4,vars:1,consts:[[1,"callback-container"],["diameter","60"],[1,"error-message"],[1,"loading-message"]],template:function(e,o){e&1&&(a(0,"div",0),v(1,"mat-spinner",1),b(2,y,2,1,"p",2)(3,I,2,0,"p",3),s()),e&2&&(c(2),h(o.errorMessage?2:3))},dependencies:[x,P,O],styles:[".callback-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:calc(100vh - 64px);padding:40px 20px;background-color:#f5f5f5;text-align:center}.callback-container[_ngcontent-%COMP%]   mat-spinner[_ngcontent-%COMP%]{margin-bottom:24px}.callback-container[_ngcontent-%COMP%]   .loading-message[_ngcontent-%COMP%]{font-size:18px;color:#000000b3;margin:0}.callback-container[_ngcontent-%COMP%]   .error-message[_ngcontent-%COMP%]{font-size:16px;color:#f44336;margin:0}@media (max-width: 768px){.callback-container[_ngcontent-%COMP%]{min-height:calc(100vh - 56px);padding:32px 16px}.callback-container[_ngcontent-%COMP%]   .loading-message[_ngcontent-%COMP%], .callback-container[_ngcontent-%COMP%]   .error-message[_ngcontent-%COMP%]{font-size:16px}}"]})};export{w as AuthCallbackComponent};
